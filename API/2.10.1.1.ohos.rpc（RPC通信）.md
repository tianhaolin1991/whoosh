# ohos.rpc（RPC通信）

本模块提供进程间通信能力，包括设备内的进程间通信（IPC）和设备间的进程间通信（RPC），前者基于Binder驱动，后者基于软总线驱动。

```cangjie
import kit.IPCKit.*
```
## Interfaces

### IRemoteBroker

interface IRemoteBroker
```cangjie
public interface IRemoteBroker { func asObject(): IRemoteObject }
```
功能： 远端对象的代理持有者。用于获取代理对象。

#### func asObject(): IRemoteObject

```cangjie
func asObject(): IRemoteObject
```
功能： 需派生类实现，获取代理或远端对象。

**Returns:**

| type | description |
| --- | --- |
| IRemoteObject | 如果调用者是RemoteObject对象，则直接返回本身；如果调用者是 RemoteProxy 对象，则返回它的持有者 IRemoteObject 。 |

**Example:**

```cangjie
// index.cj

import kit.IPCKit.*

// 此处代码可添加在依赖项定义中
class TestAbility <: IRemoteBroker {
 let remote: IRemoteObject
 init(remote: IRemoteObject) {
 this.remote = remote
 }
 public func asObject(): IRemoteObject {
 return this.remote
 }
}
```


### IRemoteObject

interface IRemoteObject
```cangjie
public interface IRemoteObject { func getLocalInterface(descriptor: String): IRemoteBroker func sendMessageRequest(code: UInt32, data: MessageSequence, reply: MessageSequence, options: MessageOption, callback: Callback1Argument<RequestResult>): Unit func registerDeathRecipient(recipient: DeathRecipient, flags: Int32): Unit func unregisterDeathRecipient(recipient: DeathRecipient, flags: Int32): Unit func getDescriptor(): String func isObjectDead(): Bool }
```
功能： 该接口可用于查询或获取接口描述符、添加或删除死亡通知、转储对象状态到特定文件、发送消息。

#### func getDescriptor(): String

```cangjie
func getDescriptor(): String
```
功能： 获取对象的接口描述符，接口描述符为字符串。

**Returns:**

| type | description |
| --- | --- |
| String | 返回接口描述符。 |

**Exceptions:**

- **BusinessException**: BusinessException：对应错误码的详细介绍请参见 RPC错误码 。

| code | description |
| --- | --- |
| 1900008 | The proxy or remote object is invalid. |


#### func getLocalInterface(descriptor: String): IRemoteBroker

```cangjie
func getLocalInterface(descriptor: String): IRemoteBroker
```
功能： 查询接口描述符的字符串。

**Parameters:**

| type | required | description | name | default |
| --- | --- | --- | --- | --- |
| String | 是 | 接口描述符的字符串。 | descriptor | - |

**Returns:**

| type | description |
| --- | --- |
| IRemoteBroker | 返回绑定到指定接口描述符的IRemoteBroker对象。 |

**Exceptions:**

- **BusinessException**: BusinessException：对应错误码的详细介绍请参见 通用错误码 。

| code | description |
| --- | --- |
| 401 | Parameter error. Possible causes: 1.The number of parameters is incorrect; 2.The parameter type does not match; 3.The string length exceeds 40960 bytes; 4.The number of bytes copied to the buffer is different from the length of the obtained string. |


#### func isObjectDead(): Bool

```cangjie
func isObjectDead(): Bool
```
功能： 检查当前对象是否死亡。

**Returns:**

| type | description |
| --- | --- |
| Bool | true：对象死亡，false：对象未死亡。 |

#### func registerDeathRecipient(recipient: DeathRecipient, flags: Int32): Unit

```cangjie
func registerDeathRecipient(recipient: DeathRecipient, flags: Int32): Unit
```
功能： 注册用于接收远程对象死亡通知的回调。如果与RemoteProxy对象匹配的远程对象进程死亡，则调用此方法。

**Parameters:**

| type | required | description | name | default |
| --- | --- | --- | --- | --- |
| DeathRecipient | 是 | 要注册的回调。 | recipient | - |
| Int32 | 是 | 死亡通知标志。 | flags | - |

**Exceptions:**

- **BusinessException**: BusinessException：对应错误码的详细介绍请参见 RPC错误码 和 通用错误码 。

| code | description |
| --- | --- |
| 401 | Parameter error. Possible causes: 1.The number of parameters is incorrect; 2.The parameter type does not match; 3.The callback used to receive remote object death notifications is empty. |
| 1900008 | The proxy or remote object is invalid. |


#### func sendMessageRequest(code: UInt32, data: MessageSequence, reply: MessageSequence, options: MessageOption, callback: Callback1Argument<RequestResult>): Unit

```cangjie
func sendMessageRequest(code: UInt32, data: MessageSequence, reply: MessageSequence, options: MessageOption, callback: Callback1Argument<RequestResult>): Unit
```
功能： 以同步或异步方式向对端进程发送MessageSequence消息。如果为选项设置了异步模式，则立即收到回调，reply报文里没有内容，具体回复需要在业务侧的回调中获取。如果为选项设置了同步模式，则将在sendRequest返回时收到回调，回复内容在reply报文里。

**Parameters:**

| type | required | description | name | default |
| --- | --- | --- | --- | --- |
| UInt32 | 是 | 本次请求调用的消息码（1-16777215），由通信双方确定。如果接口由IDL工具生成，则消息代码由IDL自动生成。 | code | - |
| MessageSequence | 是 | 保存待发送数据的MessageSequence对象。 | data | - |
| MessageSequence | 是 | 接收应答数据的MessageSequence对象。 | reply | - |
| MessageOption | 是 | 本次请求的同异步模式，默认同步调用。 | options | - |
| Callback1Argument < RequestResult > | 是 | 接收发送结果的回调。 | callback | - |

**Exceptions:**

- **BusinessException**: BusinessException：对应错误码的详细介绍请参见 通用错误码 。

| code | description |
| --- | --- |
| 401 | Parameter error. Possible causes: 1.The number of parameters is incorrect; 2.The parameter type does not match; 3.Failed to obtain the passed object instance. |


#### func unregisterDeathRecipient(recipient: DeathRecipient, flags: Int32): Unit

```cangjie
func unregisterDeathRecipient(recipient: DeathRecipient, flags: Int32): Unit
```
功能： 注销用于接收远程对象死亡通知的回调。

**Parameters:**

| type | required | description | name | default |
| --- | --- | --- | --- | --- |
| DeathRecipient | 是 | 要注销的回调。 | recipient | - |
| Int32 | 是 | 死亡通知标志。 | flags | - |

**Exceptions:**

- **BusinessException**: BusinessException：对应错误码的详细介绍请参见 RPC错误码 和 通用错误码 。

| code | description |
| --- | --- |
| 401 | Parameter error. Possible causes: 1.The number of parameters is incorrect; 2.The parameter type does not match; 3.The callback used to receive remote object death notifications is empty. |
| 1900008 | The proxy or remote object is invalid. |



### Parcelable

interface Parcelable
```cangjie
public interface Parcelable { func marshalling(dataOut: MessageSequence): Bool func unmarshalling(dataIn: MessageSequence): Bool }
```
功能： 在进程间通信（IPC）期间，将类的对象写入MessageSequence并从MessageSequence中恢复它们。

#### func marshalling(dataOut: MessageSequence): Bool

```cangjie
func marshalling(dataOut: MessageSequence): Bool
```
功能： 将此可序列对象封送到MessageSequence中。

**Parameters:**

| type | required | description | name | default |
| --- | --- | --- | --- | --- |
| MessageSequence | 是 | 可序列对象将被封送到的MessageSequence对象。 | dataOut | - |

**Returns:**

| type | description |
| --- | --- |
| Bool | true：封送成功，false：封送失败。 |

#### func unmarshalling(dataIn: MessageSequence): Bool

```cangjie
func unmarshalling(dataIn: MessageSequence): Bool
```
功能： 从MessageSequence中解封此可序列对象。

**Parameters:**

| type | required | description | name | default |
| --- | --- | --- | --- | --- |
| MessageSequence | 是 | 已将可序列对象封送到其中的MessageSequence对象。 | dataIn | - |

**Returns:**

| type | description |
| --- | --- |
| Bool | true：反序列化成功，false：反序列化失败。 |

**Example:**

```cangjie
// index.cj

import kit.IPCKit.*

// 此处代码可添加在依赖项定义中
class MyParcelable <: Parcelable {
 var num: Int32 = 0
 var str: String = ''
 init(num: Int32, str: String) {
 this.num = num
 this.str = str
 }
 public func marshalling(messageSequence: MessageSequence): Bool {
 messageSequence.writeInt(this.num)
 messageSequence.writeString(this.str)
 return true
 }
 public func unmarshalling(messageSequence: MessageSequence): Bool {
 this.num = messageSequence.readInt()
 this.str = messageSequence.readString()
 return true
 }
}

let parcelable = MyParcelable(1, "aaa")
let data = MessageSequence.create()
parcelable.marshalling(data)
parcelable.unmarshalling(data)
```



## Classes

### Ashmem

class Ashmem
```cangjie
public class Ashmem { public static const PROT_EXEC: UInt32 = 4 public static const PROT_NONE: UInt32 = 0 public static const PROT_READ: UInt32 = 1 public static const PROT_WRITE: UInt32 = 2 }
```
功能： 提供与匿名共享内存对象相关的方法，包括创建、关闭、映射和取消映射Ashmem、从Ashmem读取数据和写入数据、获取Ashmem大小、设置Ashmem保护。


### DeathRecipient

class DeathRecipient
```cangjie
public abstract class DeathRecipient {}
```
功能： 用于订阅远端对象的死亡通知。当被订阅该通知的远端对象死亡时，本端可收到消息，调用 onRemoteDied 接口。远端对象死亡可以为远端对象所在进程死亡，远端对象所在设备关机或重启，当远端对象与本端对象属于不同设备时，也可为远端对象离开组网时。


### ErrorCode

class ErrorCode
```cangjie
public class ErrorCode { public static const CHECK_PARAM_ERROR: Int32 = 401 public static const OS_MMAP_ERROR: Int32 = 1900001 public static const OS_IOCTL_ERROR: Int32 = 1900002 public static const WRITE_TO_ASHMEM_ERROR: Int32 = 1900003 public static const READ_FROM_ASHMEM_ERROR: Int32 = 1900004 public static const ONLY_PROXY_OBJECT_PERMITTED_ERROR: Int32 = 1900005 public static const ONLY_REMOTE_OBJECT_PERMITTED_ERROR: Int32 = 1900006 public static const COMMUNICATION_ERROR: Int32 = 1900007 public static const PROXY_OR_REMOTE_OBJECT_INVALID_ERROR: Int32 = 1900008 public static const WRITE_DATA_TO_MESSAGE_SEQUENCE_ERROR: Int32 = 1900009 public static const READ_DATA_FROM_MESSAGE_SEQUENCE_ERROR: Int32 = 1900010 public static const PARCEL_MEMORY_ALLOC_ERROR: Int32 = 1900011 public static const CALL_JS_METHOD_ERROR: Int32 = 1900012 public static const OS_DUP_ERROR: Int32 = 1900013 }
```
功能： 错误码对应数值及含义。


### IPCSkeleton

class IPCSkeleton
```cangjie
public class IPCSkeleton {}
```
功能： 用于获取IPC上下文信息，包括获取UID和PID、获取本端和对端设备ID、检查接口调用是否在同一设备上。


### MessageOption

class MessageOption
```cangjie
public class MessageOption { public static const TF_SYNC: Int32 = 0x00 public static const TF_ASYNC: Int32 = 0x01 public static const TF_ACCEPT_FDS: Int32 = 0x10 public static const TF_WAIT_TIME: Int32 = 0x8 public init(async!: Bool = false, waitTime!: Int32 = MessageOption.TF_WAIT_TIME) }
```
功能： 公共消息选项，使用指定的标志类型，构造指定的MessageOption对象。


### MessageSequence

class MessageSequence
```cangjie
public class MessageSequence {}
```
功能： 在RPC或IPC过程中，发送方可以使用MessageSequence提供的写方法，将待发送的数据以特定格式写入该对象。接收方可以使用MessageSequence提供的读方法从该对象中读取特定格式的数据。数据格式包括：基础类型及数组、IPC对象、接口描述符和自定义序列化对象。


### RemoteObject

class RemoteObject
```cangjie
public open class RemoteObject <: IRemoteObject { public init(descriptor: String) }
```
功能： 实现远程对象。服务提供者必须继承此类。


### RemoteProxy

class RemoteProxy
```cangjie
public class RemoteProxy <: IRemoteObject { public static const PING_TRANSACTION: Int32 = 0x5f504e47 public static const DUMP_TRANSACTION: Int32 = 0x5f444d50 public static const INTERFACE_TRANSACTION: Int32 = 0x5f4e5446 public static const MIN_TRANSACTION_ID: Int32 = 0x00000001 public static const MAX_TRANSACTION_ID: Int32 = 0x00FFFFFF }
```
功能： 实现IRemoteObject代理对象。



## Structs

### RequestResult

struct RequestResult
```cangjie
public struct RequestResult { public RequestResult( public let errCode: Int32, public let code: UInt32, public let data: MessageSequence, public let reply: MessageSequence ) }
```
功能： 发送请求的响应结果。



## Enums

### TypeCode

enum TypeCode
```cangjie
public enum TypeCode <: Equatable<TypeCode> & ToString { | INT8_ARRAY | UINT8_ARRAY | INT16_ARRAY | UINT16_ARRAY | INT32_ARRAY | UINT32_ARRAY | FLOAT32_ARRAY | FLOAT64_ARRAY | BIGINT64_ARRAY | BIGUINT64_ARRAY | ... }
```
功能： 传递数据时通过具体类型值来分辨业务是以哪一种TypedArray去进行数据的读写。

#### BIGINT64_ARRAY

```cangjie
BIGINT64_ARRAY
```
功能： TypedArray类型为BIGINT64_ARRAY。

#### BIGUINT64_ARRAY

```cangjie
BIGUINT64_ARRAY
```
功能： TypedArray类型为BIGUINT64_ARRAY。

#### FLOAT32_ARRAY

```cangjie
FLOAT32_ARRAY
```
功能： TypedArray类型为FLOAT32_ARRAY。

#### FLOAT64_ARRAY

```cangjie
FLOAT64_ARRAY
```
功能： TypedArray类型为FLOAT64_ARRAY。

#### INT16_ARRAY

```cangjie
INT16_ARRAY
```
功能： TypedArray类型为INT16_ARRAY。

#### INT32_ARRAY

```cangjie
INT32_ARRAY
```
功能： TypedArray类型为INT32_ARRAY。

#### INT8_ARRAY

```cangjie
INT8_ARRAY
```
功能： TypedArray类型为INT8_ARRAY。

#### UINT16_ARRAY

```cangjie
UINT16_ARRAY
```
功能： TypedArray类型为UINT16_ARRAY。

#### UINT32_ARRAY

```cangjie
UINT32_ARRAY
```
功能： TypedArray类型为UINT32_ARRAY。

#### UINT8_ARRAY

```cangjie
UINT8_ARRAY
```
功能： TypedArray类型为UINT8_ARRAY。



